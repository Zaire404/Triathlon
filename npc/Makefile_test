# Makefile_test
# Generic Makefile for running Verilator C++ tests

# --- Configuration ---
TEST ?= test_build_config test_ifu

# --- Paths ---
LEGACY_TEST_CPP = ./csrc/$(TEST).cpp
NESTED_TEST_CPP = ./csrc/test/$(TEST).cpp
TEST_CPP_PATH = $(firstword $(wildcard $(LEGACY_TEST_CPP) $(NESTED_TEST_CPP)))
TEST_CPP_ABSPATH = $(abspath $(if $(TEST_CPP_PATH),$(TEST_CPP_PATH),$(LEGACY_TEST_CPP)))
TEST_TB_MODULE = tb_$(subst test_,,$(TEST))
TEST_TB_SV_DIR = ./vsrc/test
TEST_TB_SV = $(TEST_TB_SV_DIR)/$(TEST_TB_MODULE).sv

# --- Build Directories ---
BUILD_DIR = ./build/$(TEST)
OBJ_DIR = $(BUILD_DIR)/obj_dir
BIN = $(BUILD_DIR)/$(TEST_TB_MODULE)

# --- Verilator ---
VERILATOR = verilator
VERILATOR_CFLAGS += -cc --exe --build -O3 --x-assign fast --x-initial fast --assert --trace
VERILATOR_CFLAGS += --Wno-fatal --Wno-WIDTH
VERILATOR_CFLAGS += -I./vsrc/include -I./vsrc
VERILATOR_CFLAGS += -I./csrc/include

PKG_VSRCS = \
	./vsrc/include/config_pkg.sv \
	./vsrc/include/test_config_pkg.sv \
	./vsrc/include/build_config_pkg.sv \
	./vsrc/include/global_config_pkg.sv \
	./vsrc/include/debug_bus_pkg.sv \
	./vsrc/include/core_contract_pkg.sv \
	./vsrc/include/riscv_pkg.sv \
	./vsrc/include/decode_pkg.sv
	
# Automatically find all other design files (non-package, non-test).
DESIGN_VSRCS = $(shell find ./vsrc -path ./vsrc/include -prune -o -path ./vsrc/test -prune -o -name "*.sv" -print)

# --- Source Files ---
VSRCS = \
	$(PKG_VSRCS) \
	$(DESIGN_VSRCS) \
	$(TEST_TB_SV)

# --- Rules ---
.PHONY: all run clean clean-all

all: $(BIN)

# The build rule for the final executable
$(BIN): $(VSRCS) $(TEST_CPP_ABSPATH)
	@rm -rf $(OBJ_DIR)
	@mkdir -p $(OBJ_DIR)
	@echo "============================================="
	@echo " VERILATING  : $(TEST_TB_MODULE) (from $(TEST_TB_SV))"
	@echo " C++ DRIVER  : $(TEST_CPP_ABSPATH)"
	@echo " INCLUDED VSRCS: $(DESIGN_VSRCS)"
	@echo "============================================="
	$(VERILATOR) $(VERILATOR_CFLAGS) \
		--top-module $(TEST_TB_MODULE) \
		$(VSRCS) $(TEST_CPP_ABSPATH) \
		--Mdir $(OBJ_DIR) -o $(abspath $(BIN))

run: $(BIN)
	@echo "============================================="
	@echo " RUNNING TEST: $(TEST)"
	@echo "============================================="
	@$(abspath $(BIN))

clean:
	@echo "Cleaning build directory for test: $(TEST)"
	rm -rf $(BUILD_DIR)

clean-all:
	@echo "Cleaning all build artifacts..."
	rm -rf ./build

# --- Run All Tests Logic ---

ALL_TESTS_ROOT = $(basename $(notdir $(wildcard ./csrc/test_*.cpp)))
ALL_TESTS_NESTED = $(basename $(notdir $(wildcard ./csrc/test/test_*.cpp)))
# Deduplicate by test name so the same test can temporarily exist in both paths.
ALL_TESTS = $(sort $(ALL_TESTS_ROOT) $(ALL_TESTS_NESTED))

.PHONY: run-all

run-all:
	@echo "============================================="
	@echo " Running $(words $(ALL_TESTS)) tests found in ./csrc and ./csrc/test"
	@echo "============================================="
	@mkdir -p ./build
	@rm -f ./build/run-all.fail
	@for test in $(ALL_TESTS); do \
		printf "Test %-25s : " "[$$test]"; \
		$(MAKE) -s -f Makefile_test TEST=$$test run > ./build/$$test.log 2>&1; \
		if [ $$? -eq 0 ]; then \
			printf "\033[32mPASS\033[0m\n"; \
		else \
			printf "\033[31mFAIL\033[0m\n"; \
			printf "    (See details in ./build/$$test.log)\n"; \
			tail -n 10 ./build/$$test.log | sed 's/^/    | /'; \
			touch ./build/run-all.fail; \
		fi; \
	done
	@echo "============================================="
	@if [ -f ./build/run-all.fail ]; then \
		printf "\033[31mSummary: Some tests failed.\033[0m\n"; \
		rm ./build/run-all.fail; \
		exit 1; \
	else \
		printf "\033[32mSummary: All tests passed!\033[0m\n"; \
	fi
